# =============================================================================
# configs/experiment/optical_baseline.yaml - å…‰å­¦åŸºçº¿å®éªŒé…ç½®
# =============================================================================

# è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å®éªŒé…ç½®æ–‡ä»¶ï¼Œå®ƒå°†æ‰€æœ‰çš„ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·
# è¿™ä¸ªæ–‡ä»¶å±•ç¤ºäº†"é…ç½®é©±åŠ¨"è®¾è®¡çš„å¨åŠ›ï¼šä¸€ä¸ªYAMLæ–‡ä»¶å®šä¹‰æ•´ä¸ªå®éªŒ

# === å®éªŒå…ƒä¿¡æ¯ ===
# æ¯ä¸ªå®éªŒéƒ½åº”è¯¥æœ‰æ¸…æ™°çš„èº«ä»½å’Œç›®æ ‡
experiment_name: "optical_swin_tiny_0728_5-fold"
description: "Optical baseline using Swin Transformer Tiny for landslide detection"
version: "1.0.0"
tags: ["optical", "baseline", "swin", "binary_classification"]

# ç ”ç©¶äººå‘˜ä¿¡æ¯ï¼ˆä¾¿äºå›¢é˜Ÿåä½œï¼‰
author: "MM-LandslideNet Team"
created_date: "2024-01-15"
notes: |
  This experiment serves as the optical baseline for our multi-modal landslide detection project.
  It uses only optical channels (R,G,B,NIR,NDVI) with a Swin Transformer Tiny backbone.
  Expected to achieve ~80% F1 score based on preliminary experiments.

# === å…¨å±€è®¾ç½® ===
seed: 3407                    # éšæœºç§å­ï¼Œç¡®ä¿å®éªŒå¯é‡ç°
log_level: "INFO"           # æ—¥å¿—çº§åˆ«ï¼šDEBUG/INFO/WARNING/ERROR

# === æ¨¡å‹é…ç½® ===
# è¿™é‡Œæˆ‘ä»¬å¼•ç”¨äº†ä¹‹å‰å®šä¹‰çš„æ¨¡å‹é…ç½®ï¼Œå¹¶åšäº†å®éªŒç‰¹å®šçš„è°ƒæ•´
model:
  target: lightning_landslide.src.models.LandslideClassificationModule
  params:
    # åŸºç¡€æ¨¡å‹ï¼šSwin Transformer
    base_model:
      target: lightning_landslide.src.models.optical_swin.OpticalSwinModel
      params:
        model_name: "swinv2_tiny_window16_256"
        input_channels: 5
        pretrained: true
        dropout_rate: 0.2
        pretrained_path: null
        img_size: 256
        # num_classes: 1
        # freeze_backbone: false
    
    # === åˆ†ç±»å¤´é…ç½® ===
    # å®šä¹‰ä»ç‰¹å¾åˆ°æœ€ç»ˆé¢„æµ‹çš„æ˜ å°„
    classifier_config:
      type: "simple"              # åˆ†ç±»å¤´ç±»å‹ï¼šsimple/mlp/attention
      hidden_dim: null            # MLPåˆ†ç±»å¤´çš„éšè—ç»´åº¦ï¼ˆsimpleç±»å‹æ—¶å¿½ç•¥ï¼‰
      use_batch_norm: false       # æ˜¯å¦ä½¿ç”¨æ‰¹æ ‡å‡†åŒ–
      activation: "relu"          # åˆ†ç±»å¤´ä¸­çš„æ¿€æ´»å‡½æ•°

    # æŸå¤±å‡½æ•°ï¼šä½¿ç”¨Focal Losså¤„ç†ç±»åˆ«ä¸å¹³è¡¡
    loss_config:
      type: "focal"
      focal_params: {alpha: 0.25, gamma: 2.0} # æˆ–è€…0.25ï¼Œéœ€è¦å®éªŒï¼Ÿ
    
    # ä¼˜åŒ–å™¨ï¼šAdamW with differential learning rates
    optimizer_config:
      type: "adamw"
      adamw_params: {lr: 4e-5, weight_decay: 1e-2, betas: [0.9, 0.95]}
      differential_lr: {enable: true, backbone_lr_ratio: 0.1, classifier_lr_ratio: 1.0}
    
    # å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼šé¢„çƒ­ + ä½™å¼¦é€€ç«
    scheduler_config:
      type: "cosine_with_warmup"
      cosine_params:
        T_0: 20          # ç¬¬ä¸€æ¬¡é‡å¯å‰çš„epochæ•°ï¼ˆé€šå¸¸è®¾ä¸ºæ€»epochæ•°çš„1/5åˆ°1/3ï¼‰
        T_mult: 1        # æ¯æ¬¡é‡å¯åå‘¨æœŸé•¿åº¦çš„å€æ•°
        eta_min: 1e-7    # æœ€å°å­¦ä¹ ç‡ï¼ˆåŸºå­¦ä¹ ç‡çš„1/100ï¼‰
    
    # è¯„ä¼°æŒ‡æ ‡
    metrics_config:
      primary_metric: "f1"
      metrics: ["accuracy", "precision", "recall", "f1", "auroc"]
      threshold: 0.5

# === æ•°æ®é…ç½® ===
# å®šä¹‰æ•°æ®å¤„ç†ç®¡é“
data:
  target: lightning_landslide.src.data.MultiModalDataModule
  params:
    # æ•°æ®è·¯å¾„
    train_data_dir: "dataset/train_data"
    test_data_dir: "dataset/test_data"
    train_csv: "dataset/Train.csv"
    test_csv: "dataset/Test.csv"
    exclude_ids_file: "dataset/data_check/exclude_ids.json"

    # === é€šé“é…ç½® ===
    # å®šä¹‰å¤šæ¨¡æ€æ•°æ®çš„é€šé“ä½¿ç”¨ç­–ç•¥
    channel_config:
      channel_groups:
        optical: [0, 1, 2, 3]          # R, G, B, NIR - å…‰å­¦é¥æ„Ÿæ•°æ®
        sar_amplitude: [4, 5, 8, 9]    # SARå¹…åº¦å›¾ - é›·è¾¾æ•°æ®çš„å¼ºåº¦ä¿¡æ¯
        sar_difference: [6, 7, 10, 11] # SARå·®å€¼å›¾ - æ—¶é—´å˜åŒ–ä¿¡æ¯  
        derived: ["ndvi"]              # æ´¾ç”ŸæŒ‡æ ‡ - è®¡ç®—å¾—å‡ºçš„æ¤è¢«æŒ‡æ•°

      # === ä½¿ç”¨æ¨¡å¼å®šä¹‰ - ä¸ºä¸åŒçš„å®éªŒæä¾›é¢„è®¾çš„é€šé“ç»„åˆ ===
      usage_modes:
        optical_only:
          groups: ["optical", "derived"]
          description: "ä»…ä½¿ç”¨å…‰å­¦æ•°æ®ï¼Œé€‚åˆåŸºçº¿å®éªŒ"
        
        # full_multimodal:
        #   groups: ["optical", "derived", "sar_amplitude", "sar_difference"]  
        #   description: "ä½¿ç”¨å…¨éƒ¨æ¨¡æ€ï¼Œé€‚åˆæœ€ç»ˆæ¨¡å‹"
        
        # sar_focused:
        #   groups: ["sar_amplitude", "sar_difference"]
        #   description: "ä¸“æ³¨SARæ•°æ®ï¼Œç”¨äºæ¶ˆèå®éªŒ"

    # é€šé“é…ç½®ï¼šä»…ä½¿ç”¨å…‰å­¦æ•°æ®
    active_mode: "optical_only"
    
    # æ•°æ®åŠ è½½é…ç½®
    batch_size: 32
    num_workers: 8
    pin_memory: true
    
    # æ•°æ®åˆ†å‰²
    val_split: 0.2
    stratify: true
    shuffle_train: true

    # === æ•°æ®é¢„å¤„ç†é…ç½® ===
    preprocessing:
      # æ ‡å‡†åŒ–å‚æ•° - åŸºäºæ‚¨çš„æ•°æ®ç»Ÿè®¡è®¡ç®—å¾—å‡º
      normalization:
        # 12ä¸ªåŸå§‹é€šé“çš„å‡å€¼å’Œæ ‡å‡†å·®
        means: [1849.282, 1953.906, 1896.493, 3291.47, -9.624, -17.110, 
                -0.699, -0.483, -10.671, -18.442, 0.248, -0.234]
        stds: [1414.462, 1338.292, 1342.528, 1448.362, 7.904, 9.245, 
              4.062, 4.283, 6.333, 8.691, 2.777, 3.932]
      
      # NDVIè®¡ç®—é…ç½®
      ndvi_computation:
        red_channel_idx: 0      # çº¢å…‰é€šé“ç´¢å¼•
        nir_channel_idx: 3      # è¿‘çº¢å¤–é€šé“ç´¢å¼•
        epsilon: 1e-8           # é¿å…é™¤é›¶çš„å°å€¼
        clip_range: [-1, 1]     # NDVIå€¼è£å‰ªèŒƒå›´

    # === æ•°æ®å¢å¼ºé…ç½® ===
    # æ•°æ®å¢å¼ºï¼šé€‚åº¦çš„å¢å¼ºç­–ç•¥
    augmentation:
      train:
        resize: 256
        # å‡ ä½•å¢å¼º
        geometric:
          random_flip: true
          h_flip_prob: 0.5
          v_flip_prob: 0.5
          random_rotation: true
          rotation_prob: 0.3
          rotation_degrees: [-10, 10]
        # å…‰è°±å¢å¼º
        spectral:
          spectral_noise: true
          noise_std: 0.005
          noise_prob: 0.3
      val: {resize: 256}
      test: {resize: 256}

# === è®­ç»ƒå™¨é…ç½® ===
# PyTorch Lightning Trainerçš„é…ç½®
trainer:
  target: pytorch_lightning.Trainer
  params:
    # åŸºç¡€è®­ç»ƒé…ç½®
    max_epochs: 100
    accelerator: "gpu"         # ä½¿ç”¨GPU
    devices: 1                 # ä½¿ç”¨1ä¸ªGPU
    precision: "32-true"       # ä½¿ç”¨32ä½ç²¾åº¦ï¼Œä¸ä½¿ç”¨æ··åˆç²¾åº¦
    
    # éªŒè¯é…ç½®
    val_check_interval: 1.0     # æ¯ä¸ªepochåéªŒè¯ï¼Œæ¯ä¸ªepochéªŒè¯ä¸€æ¬¡
    check_val_every_n_epoch: 1  # æ¯ä¸ªepochéªŒè¯ä¸€æ¬¡
    
    # æ¢¯åº¦é…ç½®
    gradient_clip_val: 1.0      # æ¢¯åº¦è£å‰ª
    accumulate_grad_batches: 1  # æ¢¯åº¦ç´¯ç§¯
    
    # æ€§èƒ½ä¼˜åŒ–
    enable_progress_bar: true   # æ˜¾ç¤ºè¿›åº¦æ¡
    enable_model_summary: true  # æ˜¾ç¤ºæ¨¡å‹æ‘˜è¦
    deterministic: false        # ä¸ºäº†æ€§èƒ½ï¼Œä¸è¦æ±‚å®Œå…¨ç¡®å®šæ€§

# === å›è°ƒå‡½æ•°é…ç½® ===
# å®šä¹‰è®­ç»ƒè¿‡ç¨‹ä¸­çš„ç›‘æ§ã€ä¿å­˜å’Œæ§åˆ¶ç­–ç•¥
callbacks:
  # æ¨¡å‹æ£€æŸ¥ç‚¹ï¼šä¿å­˜æœ€å¥½çš„æ¨¡å‹
  model_checkpoint:
    target: pytorch_lightning.callbacks.ModelCheckpoint
    params:
      filename: "best-{epoch:02d}-{val_f1:.4f}"
      monitor: "val_f1"         # ç›‘æ§æŒ‡æ ‡
      mode: "max"               # æœ€å¤§å€¼
      save_top_k: 1              # ä¿å­˜æœ€å¥½çš„1ä¸ªæ¨¡å‹
      save_last: true            # ä¿å­˜æœ€åä¸€ä¸ªæ¨¡å‹
      verbose: true              # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
  
  # æ—©åœï¼šé˜²æ­¢è¿‡æ‹Ÿåˆ
  early_stopping:
    target: pytorch_lightning.callbacks.EarlyStopping
    params:
      monitor: "val_f1"         # ç›‘æ§æŒ‡æ ‡
      mode: "max"               # æœ€å¤§å€¼
      patience: 20              # æ—©åœæ¬¡æ•°
      verbose: true              # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
      strict: false              # éä¸¥æ ¼æ¨¡å¼ï¼Œå…è®¸æŒ‡æ ‡å¶å°”ä¸å­˜åœ¨
      min_delta: 0.001
  
  # å­¦ä¹ ç‡ç›‘æ§ï¼šè¿½è¸ªå­¦ä¹ ç‡å˜åŒ–
  lr_monitor:
    target: pytorch_lightning.callbacks.LearningRateMonitor
    params:
      logging_interval: "epoch"  # è®°å½•å­¦ä¹ ç‡å˜åŒ–
      log_momentum: false        # ä¸è®°å½•åŠ¨é‡
  
  # è‡ªå®šä¹‰å›è°ƒï¼šæ¨¡å‹ç»Ÿè®¡å’Œå¯è§†åŒ–
  metrics_logger:
    target: lightning_landslide.src.utils.metrics.MetricsLogger
    params:
      summary_interval: 5  # æ¯5ä¸ªepochæ‰“å°è¯¦ç»†æ€»ç»“
      save_history: true   # ä¿å­˜å®Œæ•´å†å²

kfold:
  n_splits: 5                    # æŠ˜æ•°
  stratified: true               # æ˜¯å¦åˆ†å±‚æŠ½æ ·
  primary_metric: "f1"           # ä¸»è¦è¯„ä¼°æŒ‡æ ‡
  save_oof_predictions: true     # æ˜¯å¦ä¿å­˜OOFï¼ˆOut-of-Foldï¼‰é¢„æµ‹
  save_fold_models: true         # æ˜¯å¦ä¿å­˜æ¯æŠ˜çš„æ¨¡å‹

# === æ—¥å¿—è®°å½•å™¨é…ç½® ===
# å®šä¹‰å®éªŒè¿½è¸ªå’Œå¯è§†åŒ–æ–¹å¼
loggers:
  # TensorBoardï¼šæœ¬åœ°å¯è§†åŒ–
  tensorboard:
    target: pytorch_lightning.loggers.TensorBoardLogger
    params:
      log_graph: false           # è®°å½•è®¡ç®—å›¾
      default_hp_metric: true   # è®°å½•é»˜è®¤è¶…å‚æ•°æŒ‡æ ‡
      name: ""                  # ğŸ”§ å…³é”®ä¿®å¤ï¼šè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé¿å…åˆ›å»ºlightning_logsç›®å½•
      version: ""               # ğŸ”§ å…³é”®ä¿®å¤ï¼šè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé¿å…åˆ›å»ºversion_Xç›®å½•
  
  # å¯é€‰ï¼šæ·»åŠ W&Bæ—¥å¿—è®°å½•å™¨ï¼ˆå¦‚æœéœ€è¦åœ¨çº¿è¿½è¸ªï¼‰
  # wandb:
  #   target: pytorch_lightning.loggers.WandbLogger
  #   params:
  #     project: "mm-landslide-net"  # é¡¹ç›®åç§°
  #     name: "optical_swin_tiny_baseline"  # å®éªŒåç§°
  #     tags: ["optical", "baseline", "swin"]  # æ ‡ç­¾

# === è¾“å‡ºç›®å½•é…ç½® ===
# å®šä¹‰æ‰€æœ‰è¾“å‡ºæ–‡ä»¶çš„ä¿å­˜ä½ç½®
outputs:
  base_output_dir: "lightning_landslide/exp"

  # è·¯å¾„ä¼šä¿å­˜åˆ°experiment_name
  checkpoint_subdir: "checkpoints"
  log_subdir: "log"
  predictions_subdir: "predictions"

  # result_prefix: "optical_swin_tiny_baseline"
  # timestamp_format: "%Y%m%d_%H%M%S"

# === ç¡¬ä»¶å’Œæ€§èƒ½é…ç½® ===
compute:
  # GPUé…ç½®
  gpu_ids: [0]                  # ä½¿ç”¨çš„GPUåˆ—è¡¨
  mixed_precision: false        # ä¸å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
  
  # å†…å­˜ä¼˜åŒ–
  find_unused_parameters: false # DDPæ—¶æ˜¯å¦æŸ¥æ‰¾æœªä½¿ç”¨å‚æ•°
  sync_batchnorm: true          # æ˜¯å¦åŒæ­¥æ‰¹æ ‡å‡†åŒ–

  # æ€§èƒ½ç›‘æ§
  profiler: null                # æ€§èƒ½åˆ†æå™¨ï¼šnull/simple/advanced/pytorch
  
# === å®éªŒç‰¹å®šé…ç½® ===
# è¿™ä¸ªå®éªŒçš„ç‰¹æ®Šè®¾ç½®å’Œè¶…å‚æ•°
experiment_config:
  # æ•°æ®å¹³è¡¡ç­–ç•¥
  class_balance_strategy: "focal_loss"  # focal_loss/weighted_sampling/cost_sensitive
  
  # è¯„ä¼°ç­–ç•¥
  evaluation_strategy:
    use_tta: true                       # æµ‹è¯•æ—¶å¢å¼º
    tta_augmentations: 4                # TTAå¢å¼ºæ¬¡æ•°
    confidence_threshold: 0.5           # é¢„æµ‹ç½®ä¿¡åº¦é˜ˆå€¼
  
  # ç»“æœæŠ¥å‘Šé…ç½®
  reporting:
    generate_confusion_matrix: true  # ç”Ÿæˆæ··æ·†çŸ©é˜µ
    generate_roc_curve: true         # ç”ŸæˆROCæ›²çº¿
    generate_precision_recall_curve: true  # ç”Ÿæˆç²¾ç¡®ç‡-å¬å›ç‡æ›²çº¿
    save_predictions: true           # ä¿å­˜é¢„æµ‹ç»“æœ
    save_model_summary: true         # ä¿å­˜æ¨¡å‹æ‘˜è¦

# === è°ƒè¯•å’Œå¼€å‘é…ç½® ===
# å¼€å‘å’Œè°ƒè¯•æ—¶çš„ç‰¹æ®Šè®¾ç½®
debug:
  # å¿«é€Ÿå¼€å‘æ¨¡å¼
  fast_dev_run: false           # åªè¿è¡Œå‡ ä¸ªbatchè¿›è¡Œè°ƒè¯•
  overfit_batches: 0.0          # è¿‡æ‹Ÿåˆç‰¹å®šbatchæ•°é‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
  
  # æ•°æ®éªŒè¯
  validate_data_on_start: true  # è®­ç»ƒå‰éªŒè¯æ•°æ®å®Œæ•´æ€§
  
  # æ¨¡å‹éªŒè¯
  run_model_test: false         # è¿è¡Œæ¨¡å‹çš„å•å…ƒæµ‹è¯•
  
  # æ€§èƒ½åˆ†æ
  profile_model: false          # å¯¹æ¨¡å‹è¿›è¡Œæ€§èƒ½åˆ†æ
  
# === å®éªŒè®°å½• ===
# ä¾¿äºåç»­åˆ†æå’Œæ¯”è¾ƒçš„å®éªŒè®°å½•
experiment_log:
  expected_metrics:
    val_f1: 0.90                # é¢„æœŸçš„F1åˆ†æ•°
    val_accuracy: 0.85          # é¢„æœŸçš„å‡†ç¡®ç‡
    training_time_hours: 1.0    # é¢„æœŸçš„è®­ç»ƒæ—¶é—´
  
  baseline_comparison:
    previous_best_f1: 0.85      # ä¹‹å‰æœ€å¥½çš„F1åˆ†æ•°
    improvement_target: 0.05    # ç›®æ ‡æ”¹è¿›å¹…åº¦
