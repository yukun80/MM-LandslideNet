# =============================================================================
# optical_convnext_baseline.yaml - ConvNextv2åŸºçº¿é…ç½®ç¤ºä¾‹
# =============================================================================

# è¿™ä¸ªé…ç½®æ–‡ä»¶å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ–°æ·»åŠ çš„ConvNextv2æ¨¡å‹
# åªéœ€è¦ä¿®æ”¹model.params.base_model.targetå³å¯ä»Swin Transformeråˆ‡æ¢åˆ°ConvNextv2

# === å®éªŒå…ƒä¿¡æ¯ ===
experiment_name: "optical_convnext_tiny_baseline"
description: "ConvNextv2 baseline experiment for landslide detection using optical data"
version: "1.0.0"
tags: ["optical", "convnextv2", "baseline", "binary_classification"]

# ç ”ç©¶äººå‘˜ä¿¡æ¯
author: "MM-LandslideNet Team"
created_date: "2024-07-31"
notes: |
  ConvNextv2åŸºçº¿å®éªŒé…ç½®ï¼Œä¸Swin Transformeré…ç½®å‡ ä¹ç›¸åŒï¼Œ
  ä»…ä¿®æ”¹äº†æ¨¡å‹ç±»å‹ã€‚è¿™å±•ç¤ºäº†æ¡†æ¶çš„æ¨¡å‹æ— å…³æ€§è®¾è®¡ã€‚
  
  ä½¿ç”¨æ–¹æ³•ï¼š
  python main.py train lightning_landslide/configs/optical_convnext_baseline.yaml

# === å…¨å±€è®¾ç½® ===
seed: 3407
log_level: "INFO"

# === æ¨¡å‹é…ç½® ===
model:
  target: lightning_landslide.src.models.classification_module.LandslideClassificationModule
  params:
    # ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ConvNextv2æ¨¡å‹æ›¿ä»£Swin Transformer
    base_model:
      target: lightning_landslide.src.models.optical_convnext.OpticalConvNextModel  # å…³é”®ä¿®æ”¹ç‚¹
      params:
        # ConvNextv2æ¨¡å‹é…ç½®
        model_name: "convnextv2_tiny.fcmae_ft_in22k_in1k"  # ä½¿ç”¨tinyå˜ä½“
        input_channels: 5                                    # 5é€šé“è¾“å…¥ï¼šR,G,B,NIR,NDVI
        pretrained: true                                     # ä½¿ç”¨é¢„è®­ç»ƒæƒé‡
        dropout_rate: 0.2                                    # dropoutæ¯”ç‡
        pretrained_path: null                                # æœ¬åœ°æƒé‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰
        img_size: 256                                        # ç›®æ ‡å›¾åƒå°ºå¯¸
    
    # åˆ†ç±»å¤´é…ç½® - ä¸Swiné…ç½®å®Œå…¨ç›¸åŒ
    classifier_config:
      type: "simple"                    # ç®€å•åˆ†ç±»å¤´ï¼šLayerNorm + Dropout + Linear
      hidden_dim: null                  # nullè¡¨ç¤ºä¸ä½¿ç”¨MLPåˆ†ç±»å¤´
      use_batch_norm: false            
      activation: "relu"
    
    # æŸå¤±å‡½æ•°é…ç½® - ä¸Swiné…ç½®å®Œå…¨ç›¸åŒ
    loss_config:
      type: "focal"                     # ä½¿ç”¨Focal Losså¤„ç†ç±»åˆ«ä¸å¹³è¡¡
      focal_params: 
        alpha: 0.25                     # ç±»åˆ«æƒé‡
        gamma: 2.0                      # èšç„¦å‚æ•°
    
    # ä¼˜åŒ–å™¨é…ç½® - ä¸Swiné…ç½®å®Œå…¨ç›¸åŒ
    optimizer_config:
      type: "adamw"
      adamw_params: 
        lr: 4e-5                        # åŸºç¡€å­¦ä¹ ç‡
        weight_decay: 1e-2              # æƒé‡è¡°å‡
        betas: [0.9, 0.95]              # Adamå‚æ•°
      differential_lr:
        enable: true                    # å¯ç”¨åˆ†å±‚å­¦ä¹ ç‡
        backbone_lr_ratio: 0.1          # éª¨å¹²ç½‘ç»œå­¦ä¹ ç‡æ¯”ä¾‹
        classifier_lr_ratio: 1.0        # åˆ†ç±»å¤´å­¦ä¹ ç‡æ¯”ä¾‹
    
    # å­¦ä¹ ç‡è°ƒåº¦å™¨é…ç½® - ä¸Swiné…ç½®å®Œå…¨ç›¸åŒ
    scheduler_config:
      type: "cosine_with_warmup"
      cosine_params:
        T_0: 20                         # ä½™å¼¦é€€ç«å‘¨æœŸ
        T_mult: 1                       # å‘¨æœŸå€å¢å› å­
        eta_min: 1e-7                   # æœ€å°å­¦ä¹ ç‡
    
    # è¯„ä¼°æŒ‡æ ‡é…ç½® - ä¸Swiné…ç½®å®Œå…¨ç›¸åŒ
    metrics_config:
      primary_metric: "f1"              # ä¸»è¦ä¼˜åŒ–æŒ‡æ ‡
      metrics: ["accuracy", "precision", "recall", "f1", "auroc"]
      threshold: 0.5                    # åˆ†ç±»é˜ˆå€¼

# === æ•°æ®é…ç½® ===
# æ•°æ®é…ç½®ä¸æ¨¡å‹æ— å…³ï¼Œå› æ­¤å®Œå…¨ä¸éœ€è¦ä¿®æ”¹
data:
  target: lightning_landslide.src.data.MultiModalDataModule
  params:
    # æ•°æ®è·¯å¾„
    train_data_dir: "dataset/train_data"
    test_data_dir: "dataset/test_data" 
    train_csv: "dataset/Train.csv"
    test_csv: "dataset/Test.csv"
    exclude_ids_file: "dataset/data_check/exclude_ids.json"

    # é€šé“é…ç½® - ä½¿ç”¨å…‰å­¦æ•°æ®çš„å‰5ä¸ªé€šé“
    channel_config:
      channel_groups:
        optical: [0, 1, 2, 3]           # R, G, B, NIR
        sar_amplitude: [4, 5, 8, 9]     # è¿™é‡Œçš„é…ç½®ä¼šè¢«opticalè¦†ç›–
        sar_difference: [6, 7, 10, 11]  # è¿™é‡Œçš„é…ç½®ä¼šè¢«opticalè¦†ç›–
        
      use_groups: ["optical"]           # åªä½¿ç”¨å…‰å­¦æ•°æ®
      add_ndvi: true                    # æ·»åŠ NDVIé€šé“ï¼ˆç¬¬5ä¸ªé€šé“ï¼‰
      
    # æ•°æ®åŠ è½½é…ç½®
    batch_size: 64                      # æ‰¹æ¬¡å¤§å°
    num_workers: 8                      # æ•°æ®åŠ è½½è¿›ç¨‹æ•°
    pin_memory: true                    # å†…å­˜é”å®šåŠ é€Ÿ
    persistent_workers: true            # æŒä¹…åŒ–workerè¿›ç¨‹
    
    # æ•°æ®å¢å¼ºé…ç½®
    augmentation:
      train_transforms:
        - type: "geometric"
          params: {rotation: 15, scale: [0.8, 1.2], flip: true}
        - type: "color"  
          params: {brightness: 0.2, contrast: 0.2}
        - type: "noise"
          params: {gaussian_noise: 0.01}
          
      val_transforms:
        - type: "basic"                 # éªŒè¯é›†åªä½¿ç”¨åŸºæœ¬å˜æ¢
        
    # æ•°æ®åˆ†å‰²é…ç½®  
    split_config:
      train_ratio: 0.8                  # è®­ç»ƒé›†æ¯”ä¾‹
      val_ratio: 0.2                    # éªŒè¯é›†æ¯”ä¾‹
      stratify: true                    # åˆ†å±‚é‡‡æ ·
      
# === è®­ç»ƒå™¨é…ç½® ===
# è®­ç»ƒå™¨é…ç½®ä¸æ¨¡å‹æ— å…³ï¼Œå› æ­¤å®Œå…¨ä¸éœ€è¦ä¿®æ”¹
trainer:
  target: pytorch_lightning.Trainer
  params:
    # è®­ç»ƒæ§åˆ¶
    max_epochs: 100                     # æœ€å¤§è®­ç»ƒè½®æ•°
    min_epochs: 10                      # æœ€å°è®­ç»ƒè½®æ•°
    
    # ç¡¬ä»¶é…ç½®
    accelerator: "auto"                 # è‡ªåŠ¨é€‰æ‹©åŠ é€Ÿå™¨(GPU/CPU)
    devices: "auto"                     # è‡ªåŠ¨é€‰æ‹©è®¾å¤‡æ•°é‡
    precision: "16-mixed"               # æ··åˆç²¾åº¦è®­ç»ƒ
    
    # éªŒè¯å’Œæ£€æŸ¥ç‚¹
    check_val_every_n_epoch: 1          # æ¯è½®éªŒè¯ä¸€æ¬¡
    enable_checkpointing: true          # å¯ç”¨æ£€æŸ¥ç‚¹ä¿å­˜
    
    # æ—©åœé…ç½®
    callbacks:
      - target: pytorch_lightning.callbacks.EarlyStopping
        params:
          monitor: "val_f1"             # ç›‘æ§éªŒè¯F1åˆ†æ•°
          patience: 15                  # è€å¿ƒç­‰å¾…è½®æ•°
          mode: "max"                   # F1è¶Šå¤§è¶Šå¥½
          min_delta: 0.001              # æœ€å°æ”¹è¿›é‡
          
      - target: pytorch_lightning.callbacks.ModelCheckpoint  
        params:
          monitor: "val_f1"             # ä¿å­˜æœ€ä½³F1æ¨¡å‹
          mode: "max"
          save_top_k: 3                 # ä¿å­˜æœ€å¥½çš„3ä¸ªæ¨¡å‹
          filename: "convnext-{epoch:02d}-{val_f1:.4f}"
          
      - target: pytorch_lightning.callbacks.LearningRateMonitor
        params:
          logging_interval: "step"      # è®°å½•å­¦ä¹ ç‡å˜åŒ–
    
    # æ—¥å¿—é…ç½®
    logger:
      target: pytorch_lightning.loggers.TensorBoardLogger
      params:
        save_dir: "lightning_logs"
        name: "optical_convnext_baseline"
        
    # è°ƒè¯•å’Œä¼˜åŒ–
    gradient_clip_val: 1.0              # æ¢¯åº¦è£å‰ª
    accumulate_grad_batches: 1          # æ¢¯åº¦ç´¯ç§¯
    deterministic: true                 # ç¡®å®šæ€§è®­ç»ƒ
    benchmark: true                     # CUDNNåŸºå‡†æµ‹è¯•

# === è¾“å‡ºé…ç½® ===
output:
  # å®éªŒè¾“å‡ºç›®å½•
  experiment_dir: "lightning_landslide/exp/${experiment_name}"
  
  # ä¿å­˜å†…å®¹
  save_config: true                     # ä¿å­˜å®Œæ•´é…ç½®
  save_predictions: true                # ä¿å­˜é¢„æµ‹ç»“æœ
  save_features: false                  # ä¸ä¿å­˜ä¸­é—´ç‰¹å¾
  
  # å¯è§†åŒ–
  plot_training_curves: true            # ç»˜åˆ¶è®­ç»ƒæ›²çº¿
  plot_confusion_matrix: true           # ç»˜åˆ¶æ··æ·†çŸ©é˜µ
  plot_roc_curve: true                  # ç»˜åˆ¶ROCæ›²çº¿

# === è®¡ç®—èµ„æºé…ç½® ===
compute:
  # å†…å­˜ä¼˜åŒ–
  mixed_precision: true                 # æ··åˆç²¾åº¦è®­ç»ƒ
  compile_model: false                  # PyTorch 2.0ç¼–è¯‘ï¼ˆå¯é€‰ï¼‰
  
  # åˆ†å¸ƒå¼è®­ç»ƒï¼ˆå•GPUæ—¶å¿½ç•¥ï¼‰
  strategy: "auto"                      # è®­ç»ƒç­–ç•¥
  sync_batchnorm: false                 # æ‰¹æ¬¡å½’ä¸€åŒ–åŒæ­¥

# === å®éªŒè¿½è¸ªé…ç½® ===
tracking:
  # MLflowé›†æˆï¼ˆå¯é€‰ï¼‰
  use_mlflow: false
  mlflow_experiment_name: "landslide_detection"
  
  # Weights & Biasesé›†æˆï¼ˆå¯é€‰ï¼‰  
  use_wandb: false
  wandb_project: "mm-landslide-net"
  wandb_tags: ["convnextv2", "optical", "baseline"]

# === ä½¿ç”¨è¯´æ˜ ===
# 
# 1. åŸºç¡€è®­ç»ƒï¼š
#    python main.py train lightning_landslide/configs/optical_convnext_baseline.yaml
#
# 2. æ¨¡å‹å¯¹æ¯”ï¼š
#    # è®­ç»ƒSwin Transformer
#    python main.py train lightning_landslide/configs/optical_baseline.yaml
#    
#    # è®­ç»ƒConvNextv2  
#    python main.py train lightning_landslide/configs/optical_convnext_baseline.yaml
#    
#    # æ¯”è¾ƒä¸¤ä¸ªæ¨¡å‹çš„æ€§èƒ½
#
# 3. è¶…å‚æ•°è°ƒä¼˜ï¼š
#    python main.py train lightning_landslide/configs/optical_convnext_baseline.yaml \
#      --override model.params.optimizer_config.adamw_params.lr=5e-5 \
#      --override model.params.base_model.params.dropout_rate=0.3
#
# 4. ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ï¼š
#    python main.py train lightning_landslide/configs/optical_convnext_baseline.yaml \
#      --override model.params.base_model.params.model_name=convnextv2_small.fcmae_ft_in22k_in1k
#
# === é¢„æœŸç»“æœ ===
# 
# ConvNextv2ç›¸æ¯”Swin Transformerçš„é¢„æœŸç‰¹ç‚¹ï¼š
# âœ… è®­ç»ƒæ›´ç¨³å®šï¼Œè¾ƒå°‘å‡ºç°æ¢¯åº¦é—®é¢˜
# âœ… æ¨ç†é€Ÿåº¦é€šå¸¸æ›´å¿«
# âœ… åœ¨æŸäº›è§†è§‰ä»»åŠ¡ä¸Šç²¾åº¦æ›´é«˜
# âœ… å†…å­˜ä½¿ç”¨ç›¸å¯¹è¾ƒå°‘
# 
# é¢„æœŸæ€§èƒ½æŒ‡æ ‡ï¼š
# - éªŒè¯F1åˆ†æ•°ï¼š0.78-0.82ï¼ˆå–å†³äºæ•°æ®è´¨é‡ï¼‰
# - è®­ç»ƒæ—¶é—´ï¼šç›¸æ¯”Swinç¨å¿«
# - GPUå†…å­˜ä½¿ç”¨ï¼šç›¸æ¯”Swinç¨å°‘